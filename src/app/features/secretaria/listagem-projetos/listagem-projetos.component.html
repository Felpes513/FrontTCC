<div class="projects-container">
  <div class="header">
    <h2>{{ isOrientador ? "Meus Projetos" : "Projetos" }}</h2>

    <!-- Somente SECRETARIA -->
    <div class="filters" *ngIf="isSecretaria">
      <input
        type="text"
        placeholder="Buscar por projeto, orientador ou campus"
        [(ngModel)]="filtro"
        class="search-input"
      />
      <button class="btn-reload" (click)="recarregar()" [disabled]="carregando">
        ğŸ“± Recarregar
      </button>
      <button class="btn-add" [routerLink]="['/secretaria/projetos/novo']">
        + Adicionar Projeto
      </button>
    </div>
  </div>

  <!-- Filtros de status: SOMENTE Secretaria -->
  <div class="filter-buttons" *ngIf="isSecretaria">
    <button (click)="filtroStatus = ''">ğŸ“„ Todos</button>
    <button (click)="filtroStatus = 'EM_EXECUCAO'">ğŸš€ Em ExecuÃ§Ã£o</button>
    <button (click)="filtroStatus = 'CONCLUIDO'">âœ… ConcluÃ­dos</button>
  </div>

  <!-- Loading -->
  <div *ngIf="carregando" class="loading">
    <p>ğŸ”„ Carregando projetos...</p>
  </div>

  <!-- Erro -->
  <div *ngIf="erro" class="error-message">
    <p>âš ï¸ {{ erro }}</p>
    <button class="btn-retry" (click)="recarregar()">Tentar novamente</button>
  </div>

  <!-- GRID -->
  <div *ngIf="!carregando && !erro" class="card-grid">
    <div
      *ngFor="let projeto of projetosFiltrados(); let i = index; trackBy: trackByFn"
      class="card"
    >
      <div
        class="progress-bar"
        [ngStyle]="{ width: simularProgresso(i) + '%', background: getCor(i) }"
      ></div>

      <div class="card-body">
        <h3>{{ projeto.nomeProjeto }}</h3>

        <div class="orientador-info">
          <strong>Orientador:</strong>
          <span [class.orientador-vazio]="!temOrientador(projeto)">
            {{ getOrientadorNome(projeto) }}
          </span>
        </div>

        <div class="campus-info">
          <strong>Campus:</strong> {{ projeto.campus }}
        </div>

        <div class="alunos-info">
          <strong>Quantidade de alunos:</strong>
          <span [class.sem-alunos]="!temAlunos(projeto)">
            {{ getQuantidadeAlunos(projeto) }}
          </span>
          <span *ngIf="!temAlunos(projeto)" class="aviso">
            (nenhum aluno cadastrado)
          </span>
        </div>

        <div class="alunos-lista" *ngIf="temAlunos(projeto)">
          <strong>Alunos:</strong>
          <div class="chips">
            <span class="chip" *ngFor="let aluno of projeto.nomesAlunos">
              ğŸ‘¨â€ğŸ“ {{ aluno }}
            </span>
          </div>
        </div>
      </div>

      <div class="card-actions">
        <!-- AÃ§Ãµes da SECRETARIA -->
        <ng-container *ngIf="isSecretaria">
          <button (click)="editarProjeto(projeto.id)" class="btn-edit">âœï¸ Editar</button>
          <button (click)="excluirProjeto(projeto.id)" class="btn-delete">ğŸ—‘ï¸ Excluir</button>
        </ng-container>

        <!-- AÃ§Ãµes do ORIENTADOR -->
        <ng-container *ngIf="!isSecretaria && isOrientador">
          <ng-container *ngIf="temIdValido(projeto); else orientadorDisabled">
            <a
              class="btn-report"
              [routerLink]="['/orientador/relatorios', projeto.id]"
              title="RelatÃ³rios do Projeto"
            >ğŸ“ RelatÃ³rios</a>

            <a
              class="btn-edit"
              [routerLink]="['/orientador/projetos', projeto.id]"
              title="Selecionar alunos do projeto"
              style="margin-left: 8px"
            >ğŸ‘¥ Selecionar Alunos</a>
          </ng-container>
          <ng-template #orientadorDisabled>
            <button class="btn-report" disabled title="Projeto sem ID">ğŸ“ RelatÃ³rios</button>
            <button class="btn-edit" disabled title="Projeto sem ID" style="margin-left: 8px">
              ğŸ‘¥ Selecionar Alunos
            </button>
          </ng-template>
        </ng-container>

        <!-- AÃ§Ãµes do ALUNO -->
        <ng-container *ngIf="!isSecretaria && !isOrientador">
          <ng-container *ngIf="temIdValido(projeto); else alunoDisabled">
            <button
              class="btn-add"
              (click)="inscrever(projeto)"
              [disabled]="getStatusProjeto(projeto) === 'lotado'"
              [title]="getStatusProjeto(projeto) === 'lotado' ? 'Projeto lotado' : 'Inscrever-se no projeto'"
            >âœ… Inscrever-se</button>

            <a
              class="btn-report"
              (click)="irParaRelatorioAluno(projeto)"
              style="margin-left: 8px"
            >ğŸ“ Meu RelatÃ³rio</a>
          </ng-container>
          <ng-template #alunoDisabled>
            <button class="btn-add" disabled>âœ… Inscrever-se</button>
            <button class="btn-report" disabled style="margin-left: 8px">ğŸ“ Meu RelatÃ³rio</button>
          </ng-template>
        </ng-container>
      </div>
    </div>
  </div>

  <!-- Nenhum projeto -->
  <div *ngIf="!carregando && !erro && projetos.length === 0" class="no-projects">
    <h3>ğŸ“ Nenhum projeto encontrado</h3>
    <p *ngIf="isSecretaria">Comece criando seu primeiro projeto!</p>
    <p *ngIf="!isSecretaria && isOrientador">VocÃª ainda nÃ£o estÃ¡ vinculado a um projeto.</p>
    <p *ngIf="!isSecretaria && !isOrientador">NÃ£o hÃ¡ projetos disponÃ­veis no momento.</p>
    <button class="btn-add" *ngIf="isSecretaria" [routerLink]="['/secretaria/projetos/novo']">
      + Criar primeiro projeto
    </button>
  </div>

  <!-- Nenhum resultado -->
  <div
    *ngIf="!carregando && !erro && projetos.length > 0 && projetosFiltrados().length === 0"
    class="no-results"
  >
    <h3>ğŸ” Nenhum resultado encontrado</h3>
    <p>Tente ajustar os termos da sua busca.</p>
    <button class="btn-clear-filter" (click)="filtro = ''" *ngIf="isSecretaria">
      âŒ Limpar filtro
    </button>
  </div>
</div>
