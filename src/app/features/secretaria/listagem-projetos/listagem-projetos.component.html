<div class="projects-container">
  <div class="header">
    <h2>{{ isOrientador ? "Meus Projetos" : "Projetos" }}</h2>

    <div class="filters" *ngIf="isSecretaria">
      <input
        type="text"
        placeholder="Buscar por projeto, orientador ou campus"
        [(ngModel)]="filtro"
        class="search-input"
      />
      <button class="btn-reload" (click)="recarregar()" [disabled]="carregando">
        <mat-icon>refresh</mat-icon> Recarregar
      </button>
      <button class="btn-add" [routerLink]="['/secretaria/projetos/novo']">
        <mat-icon>add</mat-icon> Adicionar Projeto
      </button>
    </div>
  </div>

  <div class="filter-buttons" *ngIf="isSecretaria">
    <button (click)="filtroStatus = ''">
      <mat-icon>description</mat-icon> Todos
    </button>
    <button (click)="filtroStatus = 'EM_EXECUCAO'">
      <mat-icon>rocket_launch</mat-icon> Em Execução
    </button>
    <button (click)="filtroStatus = 'CONCLUIDO'">
      <mat-icon>check_circle</mat-icon> Concluídos
    </button>
  </div>

  <div *ngIf="carregando" class="loading">
    <p><mat-icon>sync</mat-icon> Carregando projetos...</p>
  </div>

  <div *ngIf="erro" class="error-message">
    <p><mat-icon>warning_amber</mat-icon> {{ erro }}</p>
    <button class="btn-retry" (click)="recarregar()">
      <mat-icon>refresh</mat-icon> Tentar novamente
    </button>
  </div>

  <div *ngIf="!carregando && !erro" class="card-grid">
    <div
      *ngFor="
        let projeto of projetosFiltrados();
        let i = index;
        trackBy: trackByFn
      "
      class="card"
    >
      <div
        class="progress-bar"
        [ngStyle]="{
          width: calcularProgresso(projeto) + '%',
          background: getCor(i)
        }"
      ></div>

      <div class="card-body">
        <div class="card-menu" *ngIf="isSecretaria">
          <button
            class="menu-trigger"
            (click)="toggleMenu(projeto.id)"
            type="button"
          >
            <mat-icon>more_vert</mat-icon>
          </button>
          <div class="menu-dropdown" *ngIf="menuAberto === projeto.id">
            <button
              class="menu-item danger"
              (click)="cancelarProjeto(projeto.id); toggleMenu(null)"
              type="button"
            >
              <mat-icon>block</mat-icon> Cancelar Projeto
            </button>
            <button
              class="menu-item warning"
              (click)="tornarAlunosInadimplentes(projeto.id); toggleMenu(null)"
              type="button"
            >
              <mat-icon>report_problem</mat-icon> Tornar Alunos Inadimplentes
            </button>
            <button
              class="menu-item warning"
              (click)="
                tornarOrientadorInadimplente(projeto.id); toggleMenu(null)
              "
              type="button"
            >
              <mat-icon>report_problem</mat-icon> Tornar Orientador Inadimplente
            </button>
            <button
              class="menu-item danger"
              (click)="tornarTodosInadimplentes(projeto.id); toggleMenu(null)"
              type="button"
            >
              <mat-icon>cancel</mat-icon> Tornar Todos Inadimplentes
            </button>
          </div>
        </div>

        <h3>{{ projeto.nomeProjeto }}</h3>

        <div class="orientador-info">
          <mat-icon>person</mat-icon>
          <strong>Orientador:</strong>
          <span [class.orientador-vazio]="!temOrientador(projeto)">{{
            getOrientadorNome(projeto)
          }}</span>
        </div>

        <div class="campus-info">
          <mat-icon>school</mat-icon>
          <strong>Campus:</strong> {{ projeto.campus }}
        </div>

        <div class="alunos-info" *ngIf="projeto.notas?.length">
          <mat-icon>grade</mat-icon>
          <strong>Notas:</strong>
          <span class="chip">Média: {{ projeto.mediaNota }}</span>
        </div>

        <div class="alunos-lista" *ngIf="temAlunos(projeto)">
          <strong>Alunos Participantes:</strong>
          <div class="chips">
            <span class="chip" *ngFor="let aluno of projeto.nomesAlunos">
              <mat-icon>person</mat-icon> {{ aluno }}
            </span>
          </div>
        </div>
      </div>

      <div class="card-actions">
        <ng-container *ngIf="isSecretaria">
          <button (click)="editarProjeto(projeto.id)" class="btn-edit">
            <mat-icon>edit</mat-icon> Editar
          </button>
          <button (click)="excluirProjeto(projeto.id)" class="btn-delete">
            <mat-icon>delete</mat-icon> Excluir
          </button>
        </ng-container>

        <ng-container *ngIf="!isSecretaria && isOrientador">
          <ng-container *ngIf="temIdValido(projeto); else orientadorDisabled">
            <a
              class="btn-report"
              [routerLink]="['/orientador/relatorios', projeto.id]"
              title="Relatórios do Projeto"
            >
              <mat-icon>assignment</mat-icon> Relatórios
            </a>
            <a
              class="btn-edit"
              [routerLink]="['/orientador/projetos', projeto.id]"
              title="Selecionar alunos do projeto"
            >
              <mat-icon>group_add</mat-icon> Selecionar Alunos
            </a>
          </ng-container>
          <ng-template #orientadorDisabled>
            <button class="btn-report" disabled title="Projeto sem ID">
              <mat-icon>assignment</mat-icon> Relatórios
            </button>
            <button class="btn-edit" disabled title="Projeto sem ID">
              <mat-icon>group_add</mat-icon> Selecionar Alunos
            </button>
          </ng-template>
        </ng-container>

        <ng-container *ngIf="isAluno">
          <ng-container *ngIf="temIdValido(projeto); else alunoDisabled">
            <button
              type="button"
              class="btn-add"
              (click)="inscrever(projeto)"
              [disabled]="isLotado(projeto) || inscrevendoId === projeto.id"
              [title]="
                isLotado(projeto)
                  ? 'Seleção finalizada'
                  : 'Inscrever-se no projeto'
              "
            >
              <mat-icon>check_circle</mat-icon>
              {{
                inscrevendoId === projeto.id ? "Inscrevendo..." : "Inscrever-se"
              }}
            </button>

            <a
              class="btn-report"
              [routerLink]="['/aluno/relatorios', projeto.id]"
            >
              <mat-icon>assignment</mat-icon> Meu Relatório
            </a>
          </ng-container>

          <ng-template #alunoDisabled>
            <button type="button" class="btn-add" disabled>
              <mat-icon>check_circle</mat-icon> Inscrever-se
            </button>
            <button type="button" class="btn-report" disabled>
              <mat-icon>assignment</mat-icon> Meu Relatório
            </button>
          </ng-template>
        </ng-container>
      </div>
    </div>
  </div>

  <div
    *ngIf="!carregando && !erro && projetos.length === 0"
    class="no-projects"
  >
    <h3><mat-icon>folder</mat-icon> Nenhum projeto encontrado</h3>
    <p *ngIf="isSecretaria">Comece criando seu primeiro projeto!</p>
    <p *ngIf="!isSecretaria && isOrientador">
      Você ainda não está vinculado a um projeto.
    </p>
    <p *ngIf="!isSecretaria && !isOrientador">
      Não há projetos disponíveis no momento.
    </p>
    <button
      class="btn-add"
      *ngIf="isSecretaria"
      [routerLink]="['/secretaria/projetos/novo']"
    >
      <mat-icon>add</mat-icon> Criar primeiro projeto
    </button>
  </div>

  <div
    *ngIf="
      !carregando &&
      !erro &&
      projetos.length > 0 &&
      projetosFiltrados().length === 0
    "
    class="no-results"
  >
    <h3><mat-icon>search</mat-icon> Nenhum resultado encontrado</h3>
    <p>Tente ajustar os termos da sua busca.</p>
    <button class="btn-clear-filter" (click)="filtro = ''" *ngIf="isSecretaria">
      <mat-icon>backspace</mat-icon> Limpar filtro
    </button>
  </div>
</div>
